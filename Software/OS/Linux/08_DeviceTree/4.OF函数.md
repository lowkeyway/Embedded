# 查找节点
Linux 内核中使用 device_node 结构体来描述一个节点，此结构体定义在文件 include/linux/of.h 中，定义如下：

```
struct device_node {
    const char *name;           /* 节点名字 */
    const char *type;           /* 设备类型 */
    phandle phandle;        
    const char *full_name;      /* 节点全名 */
    struct fwnode_handle fnode;

    struct property *properties; /* 属性 */
    struct property *deadprops;  /* removes 属性 */
    struct device_node *parend;  /* 父节点 */
    struct device_node *child;   /* 子节点 */
    struct device_node *sibling;
    struct kobject kobj;
    ...
}
```
与查找节点有关的 OF 函数有 5 个

## of_find_node_by_name
of_find_node_by_name 函数通过节点名字查找指定的节点，函数原型如下
```
struct device_node *of_find_node_by_name(struct device_node *from, const char *name);
```

参数 |	含义
-|-
from	| 开始查找的节点，如果为 NULL 表示从根节点开始查找整个设备树
name	| 要查找的节点名字
返回值	| 含义
NULL	| 查找失败
成功	| 找到的节点

## of_find_node_by_type
of_find_node_by_type 函数通过 device_type 属性查找指定的节点，函数原型如下：
```
struct device_node *of_find_node_by_type(struct device_node *from, const char *type);
```

参数 |	含义
-|-
from	| 开始查找的节点，如果为 NULL 表示从根节点开始查找整个设备树
type	| 要查找的节点对应的字符串，也就是 device_type 属性值
返回值 | 含义
NULL |	查找失败
成功	| 找到的节点

# of_find_compatible_node
of_find_compatible_node 根据 device_type 和 compatible 这两个属性查找指定的节点，函数原型如下
```
struct device_node *of_find_compatible_node(struct device_node *from, const struct of_device_id *matches, const struct of_device_id **match);
```

参数	| 含义
-|-
from	| 开始查找的节点，如果为 NULL 表示从根节点开始查找整个设备树
matches	| of_device_id 匹配表，也就是在此匹配表里面查找节点
match	| 找到的匹配的 of_device_id
返回值	| 含义
NULL	| 查找失败
成功	| 找到的节点

# of_find_node_by_path
of_find_node_by_path通过路径来查找指定的节点，函数原型如下
```
inline struct device_node *of_find_node_by_path(const char *path);
```

参数	| 含义
-|-
path |	带有全路径的节点名
返回值	| 含义
NULL	| 查找失败
成功	| 找到的节点

# 查找父/子节点的 OF 函数

## of_get_parent
用于获取指定节点的父节点(如果有父节点的话)
```
struct device_node *of_get_parent(const struct device_node *node);
```

# of_get_next_child

函数原型如下：
```
struct device_node *of_get_next_child(const struct device_node *node, struct device_node *prev);
```

参数 |	含义
-|-
node | 父节点
prev |前一个子节点，也就是从哪一个子节点开始的下一个子节点，如果为 NULL 表示从第一个子节点开始
返回值 | 找到的下一个子节点

# 提取属性值的 OF 函数

Linux 内核中使用 struct property 结构体来表示属性，原型如下
```
struct property {
    char *name; //属性名字
    int length; //属性长度
    void *value; //属性值
    struct property *next;//下一个属性
    unsigned long _flags;
    unsigned int unique_id;
    struct bin_attribute attr;
```

## of_find_property

用于查找指定的属性

```
struct property *of_find_property(const struct device_node *np, const char *name, int *lenp);
```

参数 |	含义
-|-
np |设备节点
name | 属性名字
lenp | 属性值的字节数
返回值 | 找到的属性

## of_property_count_elems_of_size

of_property_count_elems_of_size 函数用于获取属性中元素的数量，比如 reg 属性值是一个
数组，那么使用此函数可以获取到这个数组的大小，此函数原型如下：

```
int of_property_count_elems_of_size(const struct device_node *np, const char *propname int elem_size)
```

参数 |	含义
-|-
np | 设备节点。
proname | 需要统计元素数量的属性名字。
elem_size | 元素长度。
返回值 | 得到的属性元素数量。

## of_property_read_u32_index

of_property_read_u32_index 函数用于从属性中获取指定标号的 u32 类型数据值(无符号 32 位)，比如某个属性有多个 u32 类型的值，那么就可以使用此函数来获取指定标号的数据值，此
函数原型如下：
```
int of_property_read_u32_index(const struct device_node *np,
                               const char *propname,
                               u32 index, 
                               u32 *out_value)
```

参数 |	含义
-|-
np | 设备节点。
proname |  要读取的属性名字。
index | 要读取的值标号。
out_value | 读取到的值
返回值 | 0 读取成功，负值，读取失败，-EINVAL 表示属性不存在，-ENODATA 表示没有要读取的数据，-EOVERFLOW 表示属性值列表太小。

## of_property_read_u8_array

of_property_read_u16_array of_property_read_u32_array of_property_read_u64_array 函数原型如下
```
int of_property_read_u8_array(const struct device_node *np,
                                const char *propname, 
                                u8 *out_values, 
                                size_t sz)
int of_property_read_u16_array(const struct device_node *np,
                                const char *propname, 
                                u16 *out_values, 
                                size_t sz)
int of_property_read_u32_array(const struct device_node *np,
                                const char *propname, 
                                u32 *out_values,
                                size_t sz)
int of_property_read_u64_array(const struct device_node *np,
                                const char *propname, 
                                u64 *out_values,
                                size_t sz)
```

参数 |	含义
-|-
np | 设备节点。
proname |  要读取的属性名字。
out_value | 读取到的数组值，分别为 u8、u16、u32 和 u64。
sz | 要读取的数组元素数量。
返回值 | 0，读取成功，负值，读取失败，-EINVAL 表示属性不存在，-ENODATA 表示没有要读取的数据，-EOVERFLOW 表示属性值列表太小。

# # of_property_read_u8

有些属性只有一个整形值，这四个函数就是用于读取这种只有一个整形值的属性，分别用于读取 u8、u16、u32 和 u64 类型属性值，函数原型如下：

```
int of_property_read_u8(const struct device_node *np, 
                        const char *propname,
                        u8 *out_value)
int of_property_read_u16(const struct device_node *np, 
                        const char *propname,
                        u16 *out_value)
int of_property_read_u32(const struct device_node *np, 
                        const char *propname,
                        u32 *out_value)
int of_property_read_u64(const struct device_node *np, 
                        const char *propname,
                        u64 *out_value)
```

参数 |	含义
-|-
np | 设备节点。
proname | 要读取的属性名字。
out_value | 读取到的数组值。
返回值 | 0，读取成功，负值，读取失败，-EINVAL 表示属性不存在，-ENODATA 表示没有要读取的数据，-EOVERFLOW 表示属性值列表太小。

## of_property_read_string

of_property_read_string 函数用于读取属性中字符串值，函数原型如下：
```
int of_property_read_string(struct device_node *np, 
                            const char *propname,
                            const char **out_string)
```

参数 |	含义
-|-
np | 设备节点。
proname | 要读取的属性名字。
out_string | 读取到的字符串值。
返回值  | 0，读取成功，负值，读取失败。

## of_n_addr_cells

of_n_addr_cells 函数用于获取#address-cells 属性值，函数原型如下：
```
int of_n_addr_cells(struct device_node *np)
```

参数 |	含义
-|-
np | 设备节点。
返回值|获取到的#address-cells 属性值。

## of_n_size_cells

of_size_cells 函数用于获取#size-cells 属性值，函数原型如下：
```
int of_n_size_cells(struct device_node *np)
```

参数 |	含义
-|-
np|设备节点。
返回值|获取到的#size-cells 属性值。

# 其它常用的 OF 函数

## of_device_is_compatible

of_device_is_compatible 函数用于查看节点的 compatible 属性是否有包含 compat 指定的字
符串，也就是检查设备节点的兼容性，函数原型如下：
```
int of_device_is_compatible(const struct device_node *device,
                            const char *compat)
```

参数 |	含义
-|-
device|设备节点。
compat|要查看的字符串。
返回值|0，节点的 compatible 属性中不包含 compat 指定的字符串；正数，节点的 compatible属性中包含 compat 指定的字符串

## of_get_address

of_get_address 函数用于获取地址相关属性，主要是“reg”或者“assigned-addresses”属性值，函数属性如下：

```
const __be32 *of_get_address(struct device_node *dev, 
                            int index, 
                            u64 *size,
                            unsigned int *flags)
```

参数 |	含义
-|-
dev|设备节点。
index|要读取的地址标号。
size|地址长度。
flags|参数，比如 IORESOURCE_IO、IORESOURCE_MEM 等
返回值|读取到的地址数据首地址，为 NULL 的话表示读取失败。

## of_translate_address

of_translate_address 函数负责将从设备树读取到的地址转换为物理地址，函数原型如下：
```
u64 of_translate_address(struct device_node *dev,const __be32 *in_addr)
```

参数 |	含义
-|-
dev|设备节点。
in_addr|要转换的地址。
返回值|得到的物理地址，如果为 OF_BAD_ADDR 的话表示转换失败。

## of_address_to_resource

```
int of_address_to_resource(struct device_node *dev, 
                            int index,
                            struct resource *r)
```

参数 |	含义
-|-
dev|设备节点。
index|地址资源标号。
r|得到的 resource 类型的资源值。
返回值|0，成功；负值，失败。

## of_iomap
```
void __iomem *of_iomap(struct device_node *np, int index)
```

参数 |	含义
-|-
np|设备节点。
index|reg 属性中要完成内存映射的段，如果 reg 属性只有一段的话 index 就设置为 0。
返回值|经过内存映射后的虚拟内存首地址，如果为 NULL 的话表示内存映射失败。
