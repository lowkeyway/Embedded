# AWB是什么？

AWB（Auto White Balance）即自动白平衡。</br>
我还是那束光，飞过了Lens，飞过了Shutter，终于到了传感器，可它们非说我不纯！

## 白平衡

### 白光

白平衡，字面上的理解就是对白颜色的平衡。那又怎么定义白色呢？

我们在"[Camera 02-光](https://github.com/lowkeyway/Embedded/blob/master/Software/Driver/Camera/Camera%2002-%E5%85%89.md)"这一节中已经提到过光的本质，以及何为可见光。

<img src="https://github.com/lowkeyway/Embedded/blob/master/Software/Driver/Pic/Camera/Camera%20%E5%85%89%E6%98%AF%E4%BB%80%E4%B9%88.jpg">

所以白光就应该是混合了430nm ~ 790nm波长的所有的光。

至于为什么是这一段波长混合成的光才能称为白光呢？因为这是太阳光的长期对地球的驯化的结果：

<img src="https://github.com/lowkeyway/Embedded/blob/master/Software/Driver/Pic/Camera/Camera%2005-AWB%20%E5%A4%AA%E9%98%B3%E5%85%89%E7%9A%84%E5%85%89%E8%B0%B1.png">

看到没，人眼之所以能够看到430nm ~ 790nm这段波长的光，就是因为太阳光在这段光谱中的能量最大。

### 平衡

我们知道了，人类可见的太阳光就是白光（透明光），那么受光物体之所以呈现不同的颜色是因为他们不能够吸收这段波谱的光反射的结果。
所以，我们看到的白色的物体就是反射所有频段波谱光的结果，绿色的物体就是不能吸收绿色而反射绿光的结果，黑色的物体就是把所有的频段的光都吸收了。

但是，问题是，并不是所有的光源都跟太阳光一样包含了相同的波谱，并且占了相同的比例。所以，理论上，同一件白色的物体，放在不同的光源下的显示应该是呈现出不同的颜色的。
不过我们用经验告诉我们，一张白纸在阳关下是白的，在烛光下也是白的啊，没觉得会变成黄色或其他彩色啊？这是因为我们的人眼自带白平衡功能，相比之下，照相机的光传感器就更能真实反馈这种差别了：

<img src="https://github.com/lowkeyway/Embedded/blob/master/Software/Driver/Pic/Camera/Camera%2005-AWB%20%E7%99%BD%E5%B9%B3%E8%A1%A1%20%E5%90%8C%E4%B8%80%E7%89%A9%E4%BD%93%E5%9C%A8%E4%B8%8D%E5%90%8C%E5%85%89%E7%BA%BF%E4%B8%8B%E7%9A%84%E9%A2%9C%E8%89%B2.png">

从上图可见，白炽灯整张图片偏黄，荧光灯整张图片偏蓝。
相机好无辜，明明是客观反应了真实世界，却要来迎合人类的视觉系统，给自己强制加入白平衡的功能。
所以，平衡的意思就是把感光Sensor中的颜色转成人眼认为的颜色。

通常我们以白色为标准，即要求把感光Sensor中的白色转成人眼中的白色（相同的，整张其他颜色也会跟着变化），这个过程就叫做白平衡。


# AWB调节的是什么？

要想了解白平衡平衡的是什么，就要先知道为什么如白炽灯、荧光灯发出的光到底差别在哪里。

## 色温

色温，是表示光线中包含颜色成分的一个计量单位。直观的理解就是颜色的温度。不用诧异，就是我们能感知的这个温度。看它的计量单位就知道了-“K”（开尔文）。难道光还有温度？

### 光和温度的关系

我们知道，光是物体辐射时发出来的一份一份的能量。每一份能量可以称为一个光子，每个光子有自己的频率。如果这个频率敲好在可见光的范围内，就可以被人眼捕获、感知。那么，这个不同频率的光是如何产生的呢？

这一切，似乎都要从“黑体辐射”说起：

+ 现在如果我们手里有这么一个黑体（能够在任何温度下将辐射到它表面上的任何波长的能量全部吸收，即只吸收不反射外界的能量），把它搞到绝对零度（-273.15摄氏度，开氏度 = 摄氏度+273.15），这个时候它不向外辐射任何电磁波。

+ 只要给他加热，它的能量比绝对零度高一些，就会辐射出电磁波。如果它的温度非常低，它就只辐射出波长很长、能量非常低的无线电波。随着温度的上升，它所辐射出的这种波就越来越多，但同时也开始辐射出波长比较短（能量比较高）的无线电波。当温度继续升高时，就开始辐射出能量还要更高的微波，然后就是红外线了。


+ 当物体的温度达到人的体温（37℃）时，辐射的峰值处在**远红外区域**。人体同样也在发射着无线电波，但是，波长最短、能量最高的波长总是最容易探测到的，因而也是最引人注目的

+ 一旦温度达到600℃左右，辐射的峰值就处在近红外区域了。不过，这时在峰值高能一侧的小量辐射已经变得特别重要了，因为这些辐射已进入可以看到的红光区域。因此，被加热的物体就会发出暗红色的光。这种红光在总的辐射量中只占很小的百分比，但是，我们碰巧能够看到它，因而就把全部注意力都集中在这种红光上，并且说那个物体是**“红热”**了

+ 当温度再上升时，辐射的峰值继续向波长更短的方向移动，因而就发出数量越来越多、波长越来越短的可见光。这时尽管辐射出的红光更多了，但辐射中又添进了数量不多却很重要的**橙光和黄光**。当达到**1000℃**的时候，这些色光的混合使我们的眼睛产生**橙光**的印象，而到**2000℃**的时候，则产生**黄光**的印象。这并**不等于说，在1000℃时只辐射出橙光，在2000℃时只辐射出黄光**。要是这样的话，接下去我们确实就会看到“青热”的情形了。但是我们所看到的其实是各种色光的混合

+ 当温度达到**6000℃（即太阳的表面温度）**时，辐射的峰值处在可见的**黄光区域**内，这时我们看到了大量的可见光——从紫光到红光统统都有。这整个可见光区使我们的眼睛产生白光的印象，结果，太阳就成为“**白热**”了

+ 当物体比太阳还要更热时，它继续辐射出各种波长的可见光，并且数量还要更多一些。不过，这时辐射的峰值已移到蓝光区域，因此，我们的眼睛会觉得这些色光的混合不很平衡，在白光中还带点蓝色

<img src="https://github.com/lowkeyway/Embedded/blob/master/Software/Driver/Pic/Camera/Camera%2005-AWB%20%E9%BB%91%E4%BD%93%E5%8A%A0%E7%83%AD.png">

以上这个过程并不等于说，在某一温度下只辐射出长波无线电波，而在某一较高的温度下只辐射出短波无线电波，然后只辐射微波，以后又只辐射红外线，到白热。
实际上，整个辐射波长范围都被辐射出来了。不过，存在着一个辐射的峰值——辐射量最大的波长区，在这个峰值的两侧，辐射量都比较小，在低能量的一侧辐射量比峰值少，而在高能的一侧则更少。可以参考下图，不同温度下的黑体辐射光谱：

<img src="https://github.com/lowkeyway/Embedded/blob/master/Software/Driver/Pic/Camera/Camera%2005-AWB%20%E9%BB%91%E4%BD%93%E8%BE%90%E5%B0%84.png">

可以看到：
+ 1、温度越高能量越大；
+ 2、温度越高越多能量向高频方向移动；

### 冷暖色和常见的光源

冷暖色是人们心理学上的主观感受，可以以正白色5500K为界，他们在色温中的分布：

<img src="https://github.com/lowkeyway/Embedded/blob/master/Software/Driver/Pic/Camera/Camera%2005-AWB%20%E8%89%B2%E6%B8%A9%E5%86%B7%E6%9A%96%E8%89%B2.png">

我们日常生活中比较常见的光源，他们的色温分布：

<img src="https://github.com/lowkeyway/Embedded/blob/master/Software/Driver/Pic/Camera/Camera%2005-AWB%20%E5%B8%B8%E5%BB%BA%E5%85%89%E7%9A%84%E8%89%B2%E6%B8%A9.jpg">


相同的物体在不同的色温下拍照，出图是不同的：

<img src="https://github.com/lowkeyway/Embedded/blob/master/Software/Driver/Pic/Camera/Camera%2005-AWB%20%E7%9B%B8%E5%90%8C%E7%89%A9%E4%BD%93%E5%9C%A8%E4%B8%8D%E5%90%8C%E8%89%B2%E6%B8%A9%E4%B8%8B%E7%9A%84%E6%88%90%E5%83%8F.jpg">


# AWB如何调节？

